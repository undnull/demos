#include <arch/segment.h>

.section .text
intr_xx:
    pushl %ds
    pushl %es
    pushl %fs
    pushl %gs
    pushal

    movw $GDT_SELECTOR(0, 0, 2), %ax
    movw %ax, %ds
    movw %ax, %es
    movw %ax, %fs
    movw %ax, %gs

    pushl %esp
    call common_interrupt_handler
    addl $4, %esp

    popal
    popl %gs
    popl %fs
    popl %es
    popl %ds

    addl $8, %esp
    
    sti
    iret    

.macro DECLARE_INTR_PUSH1 N1, N2
.global \N1
\N1:
    cli
    pushl $0
    pushl $\N2
    jmp intr_xx
.endm

.macro DECLARE_TRAP_PUSH1 N1, N2
.global \N1
\N1:
    pushl $\N2
    jmp intr_xx
.endm

.macro DECLARE_TRAP_PUSH2 N1, N2
.global \N1
\N1:
    pushl $0
    pushl $\N2
    jmp intr_xx
.endm

DECLARE_TRAP_PUSH2 intr_00, 0x00 // division by zero
DECLARE_TRAP_PUSH2 intr_01, 0x01 // debug exception
DECLARE_INTR_PUSH1 intr_02, 0x02 // non-maskable interrupt
DECLARE_TRAP_PUSH2 intr_03, 0x03 // breakpoint
DECLARE_TRAP_PUSH2 intr_04, 0x04 // overflow
DECLARE_TRAP_PUSH2 intr_05, 0x05 // bound range exceeded
DECLARE_TRAP_PUSH2 intr_06, 0x06 // invalid opcode
DECLARE_TRAP_PUSH2 intr_07, 0x07 // device not available
DECLARE_TRAP_PUSH1 intr_08, 0x08 // double fault
DECLARE_TRAP_PUSH2 intr_09, 0x09 // coprocessor segment overrun [unused?]
DECLARE_TRAP_PUSH1 intr_0A, 0x0A // invalid tss
DECLARE_TRAP_PUSH1 intr_0B, 0x0B // segment not present
DECLARE_TRAP_PUSH1 intr_0C, 0x0C // stack-segment fault
DECLARE_TRAP_PUSH1 intr_0D, 0x0D // general protection fault
DECLARE_TRAP_PUSH1 intr_0E, 0x0E // page fault
DECLARE_TRAP_PUSH2 intr_0F, 0x0F // reserved
DECLARE_TRAP_PUSH2 intr_10, 0x10 // x87 FP exception
DECLARE_TRAP_PUSH2 intr_11, 0x11 // alignment check
DECLARE_TRAP_PUSH2 intr_12, 0x12 // machine check
DECLARE_TRAP_PUSH2 intr_13, 0x13 // SIMD FP exception
DECLARE_TRAP_PUSH2 intr_14, 0x14 // virtualization exception
DECLARE_TRAP_PUSH2 intr_15, 0x15 // reserved
DECLARE_TRAP_PUSH2 intr_16, 0x16 // reserved
DECLARE_TRAP_PUSH2 intr_17, 0x17 // reserved
DECLARE_TRAP_PUSH2 intr_18, 0x18 // reserved
DECLARE_TRAP_PUSH2 intr_19, 0x19 // reserved
DECLARE_TRAP_PUSH2 intr_1A, 0x1A // reserved
DECLARE_TRAP_PUSH2 intr_1B, 0x1B // reserved
DECLARE_TRAP_PUSH2 intr_1C, 0x1C // reserved
DECLARE_TRAP_PUSH2 intr_1D, 0x1D // reserved
DECLARE_TRAP_PUSH2 intr_1E, 0x1E // security exception
DECLARE_TRAP_PUSH2 intr_1F, 0x1F // reserved
DECLARE_INTR_PUSH1 intr_20, 0x20
DECLARE_INTR_PUSH1 intr_21, 0x21
DECLARE_INTR_PUSH1 intr_22, 0x22
DECLARE_INTR_PUSH1 intr_23, 0x23
DECLARE_INTR_PUSH1 intr_24, 0x24
DECLARE_INTR_PUSH1 intr_25, 0x25
DECLARE_INTR_PUSH1 intr_26, 0x26
DECLARE_INTR_PUSH1 intr_27, 0x27
DECLARE_INTR_PUSH1 intr_28, 0x28
DECLARE_INTR_PUSH1 intr_29, 0x29
DECLARE_INTR_PUSH1 intr_2A, 0x2A
DECLARE_INTR_PUSH1 intr_2B, 0x2B
DECLARE_INTR_PUSH1 intr_2C, 0x2C
DECLARE_INTR_PUSH1 intr_2D, 0x2D
DECLARE_INTR_PUSH1 intr_2E, 0x2E
DECLARE_INTR_PUSH1 intr_2F, 0x2F
DECLARE_INTR_PUSH1 intr_30, 0x30
DECLARE_INTR_PUSH1 intr_31, 0x31
DECLARE_INTR_PUSH1 intr_32, 0x32
DECLARE_INTR_PUSH1 intr_33, 0x33
DECLARE_INTR_PUSH1 intr_34, 0x34
DECLARE_INTR_PUSH1 intr_35, 0x35
DECLARE_INTR_PUSH1 intr_36, 0x36
DECLARE_INTR_PUSH1 intr_37, 0x37
DECLARE_INTR_PUSH1 intr_38, 0x38
DECLARE_INTR_PUSH1 intr_39, 0x39
DECLARE_INTR_PUSH1 intr_3A, 0x3A
DECLARE_INTR_PUSH1 intr_3B, 0x3B
DECLARE_INTR_PUSH1 intr_3C, 0x3C
DECLARE_INTR_PUSH1 intr_3D, 0x3D
DECLARE_INTR_PUSH1 intr_3E, 0x3E
DECLARE_INTR_PUSH1 intr_3F, 0x3F
DECLARE_INTR_PUSH1 intr_40, 0x40
DECLARE_INTR_PUSH1 intr_41, 0x41
DECLARE_INTR_PUSH1 intr_42, 0x42
DECLARE_INTR_PUSH1 intr_43, 0x43
DECLARE_INTR_PUSH1 intr_44, 0x44
DECLARE_INTR_PUSH1 intr_45, 0x45
DECLARE_INTR_PUSH1 intr_46, 0x46
DECLARE_INTR_PUSH1 intr_47, 0x47
DECLARE_INTR_PUSH1 intr_48, 0x48
DECLARE_INTR_PUSH1 intr_49, 0x49
DECLARE_INTR_PUSH1 intr_4A, 0x4A
DECLARE_INTR_PUSH1 intr_4B, 0x4B
DECLARE_INTR_PUSH1 intr_4C, 0x4C
DECLARE_INTR_PUSH1 intr_4D, 0x4D
DECLARE_INTR_PUSH1 intr_4E, 0x4E
DECLARE_INTR_PUSH1 intr_4F, 0x4F
DECLARE_INTR_PUSH1 intr_50, 0x50
DECLARE_INTR_PUSH1 intr_51, 0x51
DECLARE_INTR_PUSH1 intr_52, 0x52
DECLARE_INTR_PUSH1 intr_53, 0x53
DECLARE_INTR_PUSH1 intr_54, 0x54
DECLARE_INTR_PUSH1 intr_55, 0x55
DECLARE_INTR_PUSH1 intr_56, 0x56
DECLARE_INTR_PUSH1 intr_57, 0x57
DECLARE_INTR_PUSH1 intr_58, 0x58
DECLARE_INTR_PUSH1 intr_59, 0x59
DECLARE_INTR_PUSH1 intr_5A, 0x5A
DECLARE_INTR_PUSH1 intr_5B, 0x5B
DECLARE_INTR_PUSH1 intr_5C, 0x5C
DECLARE_INTR_PUSH1 intr_5D, 0x5D
DECLARE_INTR_PUSH1 intr_5E, 0x5E
DECLARE_INTR_PUSH1 intr_5F, 0x5F
DECLARE_INTR_PUSH1 intr_60, 0x60
DECLARE_INTR_PUSH1 intr_61, 0x61
DECLARE_INTR_PUSH1 intr_62, 0x62
DECLARE_INTR_PUSH1 intr_63, 0x63
DECLARE_INTR_PUSH1 intr_64, 0x64
DECLARE_INTR_PUSH1 intr_65, 0x65
DECLARE_INTR_PUSH1 intr_66, 0x66
DECLARE_INTR_PUSH1 intr_67, 0x67
DECLARE_INTR_PUSH1 intr_68, 0x68
DECLARE_INTR_PUSH1 intr_69, 0x69
DECLARE_INTR_PUSH1 intr_6A, 0x6A
DECLARE_INTR_PUSH1 intr_6B, 0x6B
DECLARE_INTR_PUSH1 intr_6C, 0x6C
DECLARE_INTR_PUSH1 intr_6D, 0x6D
DECLARE_INTR_PUSH1 intr_6E, 0x6E
DECLARE_INTR_PUSH1 intr_6F, 0x6F
DECLARE_INTR_PUSH1 intr_70, 0x70
DECLARE_INTR_PUSH1 intr_71, 0x71
DECLARE_INTR_PUSH1 intr_72, 0x72
DECLARE_INTR_PUSH1 intr_73, 0x73
DECLARE_INTR_PUSH1 intr_74, 0x74
DECLARE_INTR_PUSH1 intr_75, 0x75
DECLARE_INTR_PUSH1 intr_76, 0x76
DECLARE_INTR_PUSH1 intr_77, 0x77
DECLARE_INTR_PUSH1 intr_78, 0x78
DECLARE_INTR_PUSH1 intr_79, 0x79
DECLARE_INTR_PUSH1 intr_7A, 0x7A
DECLARE_INTR_PUSH1 intr_7B, 0x7B
DECLARE_INTR_PUSH1 intr_7C, 0x7C
DECLARE_INTR_PUSH1 intr_7D, 0x7D
DECLARE_INTR_PUSH1 intr_7E, 0x7E
DECLARE_INTR_PUSH1 intr_7F, 0x7F
DECLARE_INTR_PUSH1 intr_80, 0x80
DECLARE_INTR_PUSH1 intr_81, 0x81
DECLARE_INTR_PUSH1 intr_82, 0x82
DECLARE_INTR_PUSH1 intr_83, 0x83
DECLARE_INTR_PUSH1 intr_84, 0x84
DECLARE_INTR_PUSH1 intr_85, 0x85
DECLARE_INTR_PUSH1 intr_86, 0x86
DECLARE_INTR_PUSH1 intr_87, 0x87
DECLARE_INTR_PUSH1 intr_88, 0x88
DECLARE_INTR_PUSH1 intr_89, 0x89
DECLARE_INTR_PUSH1 intr_8A, 0x8A
DECLARE_INTR_PUSH1 intr_8B, 0x8B
DECLARE_INTR_PUSH1 intr_8C, 0x8C
DECLARE_INTR_PUSH1 intr_8D, 0x8D
DECLARE_INTR_PUSH1 intr_8E, 0x8E
DECLARE_INTR_PUSH1 intr_8F, 0x8F
DECLARE_INTR_PUSH1 intr_90, 0x90
DECLARE_INTR_PUSH1 intr_91, 0x91
DECLARE_INTR_PUSH1 intr_92, 0x92
DECLARE_INTR_PUSH1 intr_93, 0x93
DECLARE_INTR_PUSH1 intr_94, 0x94
DECLARE_INTR_PUSH1 intr_95, 0x95
DECLARE_INTR_PUSH1 intr_96, 0x96
DECLARE_INTR_PUSH1 intr_97, 0x97
DECLARE_INTR_PUSH1 intr_98, 0x98
DECLARE_INTR_PUSH1 intr_99, 0x99
DECLARE_INTR_PUSH1 intr_9A, 0x9A
DECLARE_INTR_PUSH1 intr_9B, 0x9B
DECLARE_INTR_PUSH1 intr_9C, 0x9C
DECLARE_INTR_PUSH1 intr_9D, 0x9D
DECLARE_INTR_PUSH1 intr_9E, 0x9E
DECLARE_INTR_PUSH1 intr_9F, 0x9F
DECLARE_INTR_PUSH1 intr_A0, 0xA0
DECLARE_INTR_PUSH1 intr_A1, 0xA1
DECLARE_INTR_PUSH1 intr_A2, 0xA2
DECLARE_INTR_PUSH1 intr_A3, 0xA3
DECLARE_INTR_PUSH1 intr_A4, 0xA4
DECLARE_INTR_PUSH1 intr_A5, 0xA5
DECLARE_INTR_PUSH1 intr_A6, 0xA6
DECLARE_INTR_PUSH1 intr_A7, 0xA7
DECLARE_INTR_PUSH1 intr_A8, 0xA8
DECLARE_INTR_PUSH1 intr_A9, 0xA9
DECLARE_INTR_PUSH1 intr_AA, 0xAA
DECLARE_INTR_PUSH1 intr_AB, 0xAB
DECLARE_INTR_PUSH1 intr_AC, 0xAC
DECLARE_INTR_PUSH1 intr_AD, 0xAD
DECLARE_INTR_PUSH1 intr_AE, 0xAE
DECLARE_INTR_PUSH1 intr_AF, 0xAF
DECLARE_INTR_PUSH1 intr_B0, 0xB0
DECLARE_INTR_PUSH1 intr_B1, 0xB1
DECLARE_INTR_PUSH1 intr_B2, 0xB2
DECLARE_INTR_PUSH1 intr_B3, 0xB3
DECLARE_INTR_PUSH1 intr_B4, 0xB4
DECLARE_INTR_PUSH1 intr_B5, 0xB5
DECLARE_INTR_PUSH1 intr_B6, 0xB6
DECLARE_INTR_PUSH1 intr_B7, 0xB7
DECLARE_INTR_PUSH1 intr_B8, 0xB8
DECLARE_INTR_PUSH1 intr_B9, 0xB9
DECLARE_INTR_PUSH1 intr_BA, 0xBA
DECLARE_INTR_PUSH1 intr_BB, 0xBB
DECLARE_INTR_PUSH1 intr_BC, 0xBC
DECLARE_INTR_PUSH1 intr_BD, 0xBD
DECLARE_INTR_PUSH1 intr_BE, 0xBE
DECLARE_INTR_PUSH1 intr_BF, 0xBF
DECLARE_INTR_PUSH1 intr_C0, 0xC0
DECLARE_INTR_PUSH1 intr_C1, 0xC1
DECLARE_INTR_PUSH1 intr_C2, 0xC2
DECLARE_INTR_PUSH1 intr_C3, 0xC3
DECLARE_INTR_PUSH1 intr_C4, 0xC4
DECLARE_INTR_PUSH1 intr_C5, 0xC5
DECLARE_INTR_PUSH1 intr_C6, 0xC6
DECLARE_INTR_PUSH1 intr_C7, 0xC7
DECLARE_INTR_PUSH1 intr_C8, 0xC8
DECLARE_INTR_PUSH1 intr_C9, 0xC9
DECLARE_INTR_PUSH1 intr_CA, 0xCA
DECLARE_INTR_PUSH1 intr_CB, 0xCB
DECLARE_INTR_PUSH1 intr_CC, 0xCC
DECLARE_INTR_PUSH1 intr_CD, 0xCD
DECLARE_INTR_PUSH1 intr_CE, 0xCE
DECLARE_INTR_PUSH1 intr_CF, 0xCF
DECLARE_INTR_PUSH1 intr_D0, 0xD0
DECLARE_INTR_PUSH1 intr_D1, 0xD1
DECLARE_INTR_PUSH1 intr_D2, 0xD2
DECLARE_INTR_PUSH1 intr_D3, 0xD3
DECLARE_INTR_PUSH1 intr_D4, 0xD4
DECLARE_INTR_PUSH1 intr_D5, 0xD5
DECLARE_INTR_PUSH1 intr_D6, 0xD6
DECLARE_INTR_PUSH1 intr_D7, 0xD7
DECLARE_INTR_PUSH1 intr_D8, 0xD8
DECLARE_INTR_PUSH1 intr_D9, 0xD9
DECLARE_INTR_PUSH1 intr_DA, 0xDA
DECLARE_INTR_PUSH1 intr_DB, 0xDB
DECLARE_INTR_PUSH1 intr_DC, 0xDC
DECLARE_INTR_PUSH1 intr_DD, 0xDD
DECLARE_INTR_PUSH1 intr_DE, 0xDE
DECLARE_INTR_PUSH1 intr_DF, 0xDF
DECLARE_INTR_PUSH1 intr_E0, 0xE0
DECLARE_INTR_PUSH1 intr_E1, 0xE1
DECLARE_INTR_PUSH1 intr_E2, 0xE2
DECLARE_INTR_PUSH1 intr_E3, 0xE3
DECLARE_INTR_PUSH1 intr_E4, 0xE4
DECLARE_INTR_PUSH1 intr_E5, 0xE5
DECLARE_INTR_PUSH1 intr_E6, 0xE6
DECLARE_INTR_PUSH1 intr_E7, 0xE7
DECLARE_INTR_PUSH1 intr_E8, 0xE8
DECLARE_INTR_PUSH1 intr_E9, 0xE9
DECLARE_INTR_PUSH1 intr_EA, 0xEA
DECLARE_INTR_PUSH1 intr_EB, 0xEB
DECLARE_INTR_PUSH1 intr_EC, 0xEC
DECLARE_INTR_PUSH1 intr_ED, 0xED
DECLARE_INTR_PUSH1 intr_EE, 0xEE
DECLARE_INTR_PUSH1 intr_EF, 0xEF
DECLARE_INTR_PUSH1 intr_F0, 0xF0
DECLARE_INTR_PUSH1 intr_F1, 0xF1
DECLARE_INTR_PUSH1 intr_F2, 0xF2
DECLARE_INTR_PUSH1 intr_F3, 0xF3
DECLARE_INTR_PUSH1 intr_F4, 0xF4
DECLARE_INTR_PUSH1 intr_F5, 0xF5
DECLARE_INTR_PUSH1 intr_F6, 0xF6
DECLARE_INTR_PUSH1 intr_F7, 0xF7
DECLARE_INTR_PUSH1 intr_F8, 0xF8
DECLARE_INTR_PUSH1 intr_F9, 0xF9
DECLARE_INTR_PUSH1 intr_FA, 0xFA
DECLARE_INTR_PUSH1 intr_FB, 0xFB
DECLARE_INTR_PUSH1 intr_FC, 0xFC
DECLARE_INTR_PUSH1 intr_FD, 0xFD
DECLARE_INTR_PUSH1 intr_FE, 0xFE
DECLARE_INTR_PUSH1 intr_FF, 0xFF
